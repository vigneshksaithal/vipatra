<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- bootstrap CSS -->
    <link defer rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.12"></script>
    <link rel="manifest" href="/manifest.json">
    <style>
      [v-cloak] {
      display: none;
      }
      
      .navbar svg{
      color: currentColor;
      width: 1.3em;
      height: 1.3em;
      margin-right: 15px;
      }
    </style>
    <title>Vipatra</title>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <a class="navbar-brand">
      <img src="https://vipatra.in/images/vipatra-logo-small.png" width="30" height="30" class="d-inline-block align-top" alt="vipatra_logo" loading="lazy">Vipatra</a>
      <button class="navbar-toggler btn btn-dark" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" href="/store/new-bill">
              <i data-feather="plus"></i>
               New Bill
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/store/items">
              <i data-feather="align-justify"></i>
              Inventory
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/store/reports">
              <i fill="currentColor" data-feather="bar-chart"></i>
              Reports
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/store/account">
              <i data-feather="user"></i>
              Account
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/store/help">
              <i data-feather="help-circle"></i>
              Help
            </a>
          </li>
        </ul>
      </div>
    </nav>
    
  </head>
  <body>
    <!-- START -->
    <script src="https://www.gstatic.com/firebasejs/7.19.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.19.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.19.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.6.1/firebase-analytics.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/7.19.1/firebase-performance.js"></script>
    <script src="https://vipatra.in/firebase/prod.js"></script>
    <!--  END Firebase initial -->
    
    <section v-cloak id="body">
    
      <div class="container">
        <h4 class="text-center my-3">All Sales</h4>
        <div class="row">
          <div class="col">
          
            <table class="table table-sm table-hover">
              <thead>
                <tr>
                  <th scope="col">#</th>
                  <th scope="col">Date</th>
                  <th scope="col">Amount</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="(bill, index) in bills" :key="bill.docId" @click="row_click(bill)">
                  <td>{{ ++index }}</td>
                  <td>{{ bill.date }}</td>
                  <td>₹ {{ bill.totalAmount }}</td>
                </tr>
              </tbody>
            </table>
            <div class="text-center">
              <button @click="show_more" class="btn btn-outline-primary">Show More</button>
            </div>
          </div>
        </div>
      </div>
      <div id="view-bill" class="modal fade" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Bill</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <span>Date: {{ billDate }}</span>
              <br>
              <span>Bill No. {{ billNo }}</span>
              <br><br>
              <table class="table table-sm table-hover">
                <thead>
                  <tr>
                    <th scope="col">#</th>
                    <th scope="col">Item</th>
                    <th scope="col">Qty</th>
                    <th scope="col">Price</th>
                    <th scope="col">Discount</th>
                    <th scope="col">Total</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="(item, index) in items" :key="item.name">
                    <td scope="row">{{ ++index }}</td>
                    <td scope="row">{{ item.name }}</td>
                    <td>{{ item.qty }}</td>
                    <td>{{ item.price }}</td>
                    <td>{{ item.discount }}</td>
                    <td>{{ item.total }}</td>
                  </tr>
                  <tr>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <th>Total</th>
                    <th>₹ {{ totalAmount }}</th>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-primary" data-dismiss="modal">Back</button>
            </div>
          </div>
        </div>
      </div>
    </section>
    <script defer>                         
      var app = new Vue({
        el: '#body',
        data: {
          userId: '',
          bills: [],
          billDate: '',
          billNo: '',
          lastDoc: '',
          items: [],
          totalAmount: 0   
        },
        methods: {
        
          get_user_id () {
            auth.onAuthStateChanged((user) => {
            
              if(user){
                 this.userId = (user.uid);
                 this.show_bills()
              }
              else{
                document.write('Please Login')
                setTimeout(() => {
                  window.location.href = '/store/login'
                }, 1000)
              }
            })
          },
        
          show_bills() {
            db.collection('bills')
            .where('bizId','==', this.userId)
            .orderBy('date', 'desc')
            .limit(5)
            .get()
            .then((snapshot) => {
              snapshot.docs.forEach(doc => {
                let val = doc.data().bill
                this.bills.push({
                  date: this.format_date(val.date.toDate()),
                  billNo: val.num,
                  totalAmount: val.totalAmount,
                  items: val.items,
                  docId: doc.id     
                })
                this.lastDoc = doc
              })
            })  
          },
          
          format_date(val){
            let date = new Date(val)
            let dd = String(date.getDate()).padStart(2, '0')
            let mm = String(date.getMonth() + 1).padStart(2, '0') //January is 0!
            let yyyy = date.getFullYear()
         
            date = dd + '-' + mm + '-' + yyyy
            return date
          },  
        
          show_more() {
            db.collection('bills')
            .where('bizId','==', this.userId)
            .orderBy('date', 'desc')
            .startAfter(this.lastDoc)
            .get()
            .then((snapshot) => {
              snapshot.docs.forEach(doc => {
                let val = doc.data().bill
                this.bills.push({
                  date: this.format_date(val.date.toDate()),
                  totalAmount: val.totalAmount     
                })
                this.lastDoc = doc
              })
            })  
          },
          
          row_click(bill) {
            $('#view-bill').modal('show')
            this.items = bill.items
            this.billDate = bill.date
            this.totalAmount = bill.totalAmount
            this.billNo = bill.billNo
          }                                                                                
        
        }   
      })        
      document.addEventListener('DOMContentLoaded', () => {
        app.get_user_id()
        app.show_bills()
        feather.replace()      
      })
      
    </script>
    <!-- jQuery & JS bundle w/ Popper.js -->
    <script defer src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    
    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
    
    <!-- feather icons -->
    <script defer src="https://cdn.jsdelivr.net/npm/feather-icons@4.28.0/dist/feather.min.js" integrity="sha256-XfzdiC+S1keia+s9l07y7ye5a874sBq67zK4u7LTjvk=" crossorigin="anonymous"></script>
  </body>
</html>
