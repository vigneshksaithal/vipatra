<!doctype html>
<html lang="en">
  <head>  
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
    <!-- vue@2.6.12 -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.min.js" integrity="sha256-KSlsysqp7TXtFo/FHjb1T9b425x3hrvzjMWaJyKbpcI=" crossorigin="anonymous"></script>
    
    <!-- bootstrap@4.5.3 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    
    <style>
      [v-cloak]{
      display: none
      }
      .navbar svg{
      color: currentColor;
      width: 1.3em;
      height: 1.3em;
      margin-right: 15px;
      }
    </style>
    
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <a class="navbar-brand">
      <img src="https://vipatra.in/images/vipatra-logo-small.png" width="30" height="30" class="d-inline-block align-top" alt="vipatra_logo" loading="lazy">Vipatra</a>
      <button class="navbar-toggler btn btn-dark" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" href="/store/new-bill">
              <i data-feather="plus"></i>
               New Bill
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/store/items">
              <i data-feather="align-justify"></i>
              Inventory
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/store/reports">
              <i fill="currentColor" data-feather="bar-chart"></i>
              Reports
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/store/account">
              <i data-feather="user"></i>
              Account
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/store/help">
              <i data-feather="help-circle"></i>
              Help
            </a>
          </li>
        </ul>
      </div>
    </nav>
    
     <!-- START -->
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-analytics.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.0.0/firebase-performance.js"></script>
    <script src="/firebase/prod.js"></script>
    <!--  END Firebase initial -->
    
  </head>
  
  <body>
    <section v-cloak id="body">
    
      <h5 class="text-center mt-3 mb-3">Day Book</h5>
           
        <div class="container">
          <h5 class="my-1">Total Sales = ₹ {{ totalSales }}</h5>
            <div v-show="showSpinner" class="text-center">
              <div class="spinner-border my-3 text-center" role="status">
              <span class="sr-only">Loading...</span>
            </div>
          </div>
            
            <table v-show="showTable" class="table table-sm my-3">
              <thead>
              <tr>
                <th>#</th>
                <th>Bill No</th>
                <th>Amount</th>
              </tr>
              </thead>
              <tbody>
                <tr v-for="(bill, index) in bills">
                  <td>{{ ++index }}</td>
                  <td>{{ bill.billNum }}</td>
                  <td>₹ {{ bill.totalAmount }}</td>
                </tr>
              </tbody>
            </table>
            
            <div v-show="showAlert" class="alert alert-warning"  role="alert" >No bills to show!</div>          
            
          </div>
      
        </section>
      
     <script>
    
      var app = new Vue({
        el: '#body',
        data() {
          return {
            todaysDate: '',
            userId: '',
            showTable: false,
            showSpinner: true,
            totalSales: 0,
            billAmount: 0,
            billDate: '',
            bills: [],
            showAlert: false
          }
        },
        methods: { 
               
          show_bills() {
            let todaysDate = this.get_todays_date()
    
            db.collection('bills')
            .where('bizId','==', this.userId)
            .where('bill.date', '>=', todaysDate)
            .where('bill.date', '<=', todaysDate)
            .orderBy('bill.date', 'desc')
            .get()
            .then((querySnapshot) => {             
               querySnapshot.docs.forEach((doc) => {
              let val = doc.data().bill
              this.totalSales += parseFloat(val.totalAmount)
              this.bills.push({
                billNum: val.num,
                totalAmount: val.totalAmount,
                docId: doc.id                                  
              })
              console.log(val.date)                
            })
            })
            .then(() => {
              this.showSpinner = false
              this.showTable = true   
            }).catch((error) => {
               console.log(error.message,'4')
               this.showSpinner = false
               this.showAlert = true  
             })    
          },          
          
          format_date(value) {
            let date = new Date(value)
            let dd = String(date.getDate()).padStart(2, '0')
            let mm = String(date.getMonth() + 1).padStart(2, '0') /*January is 0!*/
            let yyyy = date.getFullYear()
        
            date = dd + '-' + mm + '-' + yyyy
            return date
          }, 
        
          get_todays_date() {
            let date = new Date()
            let dd = String(date.getDate()).padStart(2, '0')
            let mm = String(date.getMonth() + 1).padStart(2, '0') //January is 0!
            let yyyy = date.getFullYear()
        
            date = yyyy + '-' + mm + '-' + dd
            return (new Date(date))
          },
          
          get_user_id() {
            auth.onAuthStateChanged((user) => {           
              if (user) {
                this.userId = (user.uid)
                this.show_bills()
              }
              else {
                document.write('Please Login')
                setTimeout(() => {
                window.location.href = '/store/login'
              }, 1000)
              }
            })
          }
                                                                                       
        }
      })
      document.addEventListener('DOMContentLoaded', () => {        
        app.get_user_id()
        feather.replace()
      })
      
    </script>
      
      <!-- jQuery & JS bundle w/ Popper.js -->
    <script defer src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>    
    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
    
    <!-- feather icons -->
    <script defer src="https://cdn.jsdelivr.net/npm/feather-icons@4.28.0/dist/feather.min.js" integrity="sha256-XfzdiC+S1keia+s9l07y7ye5a874sBq67zK4u7LTjvk=" crossorigin="anonymous"></script>
  </body>
</html>
